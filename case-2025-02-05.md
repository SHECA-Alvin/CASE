## Incident Report

### Summary

SHECA为合作伙伴签发了新的中级根证书，并配置了新的证书产品。然而，在使用中级根 **Keymatic Secure Domain ECC CA G1** 签发 DV SSL 证书时，由于操作员失误，将该中级根下的 DV 证书产品误引用了 OV 证书模板，导致签发的证书中 **certificatePolicies** 扩展项包含 OV 证书的 OID，同时证书的 DN 中仅包含 **CN** 和 **C** 两个属性。

### Impact

以下三张证书格式存在错误，目前已均被客户吊销

https://crt.sh/?id=16556132396

https://crt.sh/?id=16546315389

https://crt.sh/?id=16535669659

### Timeline

All times are UTC+8.

2025-01-05:

- 15:00 SHECA为合作伙伴签发新的定制中级根 Keymatic Secure Domain ECC CA G1。

2024-01-24:

- 21:00 CA系统操作员配置新的中级根（Keymatic Secure Domain ECC CA G1）的订户证书模板并刷新缓存使模板生效。

2024-02-05:

- 15:00 订户申请签发ECC算法证书，SHECA共签发三张证书。

2024-02-07:

- **17:21**  SHECA的合规部门收到告警，告警显示由Keymatic Secure Domain ECC CA G1 签发的三张证书存在格式问题，告警来自lingting的定时任务，该定时任务会在每周五对所有在未吊销的证书执行linting，对问题的证书会进行告警通知。
- **17:30**  合规部门通知停止使用Keymatic Secure Domain ECC CA G1 签发证书。
- **23:44** SHECA 收到第三方邮件通知证书存在格式问题，经核实，与上述证书一致。

2024-02-08:

- 10:02 CA系统操作员检查中级根Keymatic Secure Domain ECC CA G1关联的证书产品模板，发现该中级根对应的证书产品引用的模板为OV SSL 证书模板。
- 10:10 重新检查所有证书产品的配置，确认无其他证书产品模板配置存在问题。
- 10:40 CA系统操作员重新配置Keymatic Secure Domain ECC CA G1关联的证书产品模板，并刷新缓存。
- 11:00 排查linting未拦截的原因，SHECA严格依照BR的要求，会对待签名的证书和已签名的证书执行linting。
- 15:01 排查到linting未拦截的原因是由于linting白名单中未包含 Keymatic Secure Domain ECC CA G1关联的证书产品编码导致的。



### Root Cause Analysis

**原因一**

SHECA 的 CA 系统操作员误操作，将 Keymatic Secure Domain ECC CA G1 关联的证书产品模板错误地引用为 OV SSL 证书模板。

**原因二**

SHECA 除了签发标准的 SSL 证书外，还会签发其他类型的证书（如设备证书等）。这些证书使用非可信的根证书签发，因此其格式无法通过 linting 校验。为此，通过配置产品白名单的方式，限定哪些证书产品需要经过 linting 校验。然而，在此次新增产品时，未及时通知研发将该产品加入白名单，导致 linting 校验失效，未能拦截本次错误签发。



### Lessons Learned

#### What went well

* SHECA的对所有未吊销的证书定期执行linting，使得SHECA很快发现了改问题。

#### What didn't go well

* 证书模板的配置缺乏二次审核机制
* 产品上线流程不规范

#### Where we got lucky

* 不适用

### Action Items

| Action Item                                                  | Kind    | Due Date   |
| ------------------------------------------------------------ | ------- | ---------- |
| 规范产品上线流程，将添加linting白名单这一步骤增加到产品上线流程中 | Prevent | 2025-02-30 |
| 增加产品配置后的二次审批机制，在操作员配置完成后由审核员进行二次审核，审核通过后才可生效 | Prevent | 2025-02-30 |

### Appendix

https://crt.sh/?id=16556132396

https://crt.sh/?id=16546315389

https://crt.sh/?id=16535669659
